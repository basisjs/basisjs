<!doctype html>

<html>

<head>
  <meta charset="utf-8">

  <title>Basis.js demos: Using of satellites</title>

  <style type="text/css" id="demo-css">
    HTML,
    BODY
    {
      font-size: small;
      font-family: Tahoma, Verdana, Arial, sans-serif;
    }

    .Demo-Section
    {
      width: 300px;
      float: left;
      border-right: 1px solid #EEE;
      margin-right: 10px;
      padding-right: 10px;
    }

    #UserList,
    #GroupList
    {
      float: left;
      margin-right: 1ex;
      background: white;
      border: 1px solid #AAA;
      height: 400px;
      width: 300px;
      overflow: auto;
      overflow-y: scroll;
      overflow-x: hidden;
    }

    .user
    {
      overflow: hidden;
      border-bottom: 1px solid #E0E0E0;
      cursor: pointer;
    }
    .user:hover
    {
      background: #E8E8E9;
    }
    .user.selected
    {
      background: #D9E8FB;
      cursor: default;
    }
    .user__title
    {
      display: block;
      padding: .5em 1ex;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .groupPanel
    {
      float: right;
      padding-left: 1ex;
      padding-top: 7px;
    }
    .groupPanel BUTTON
    {
      position: relative;
      top: -2px;
      margin: 0 12px 0 8px;
    }

    .noGroup
    {
      color: #888;
      font-style: italic;
    }
    .group
    {
      overflow: hidden;
      border-bottom: 1px solid #E0E0E0;
    }
    .group BUTTON
    {
      float: right;
    }
    .group .Basis-Field
    {
      overflow: hidden;
    }
    .group .Basis-Field-Container
    {
      margin: 0 10px 0 2px;
    }
    .group .Basis-Field INPUT
    {
      width: 100%;
    }

    #demo-changeGroupingList
    {
      margin: .5em 0;
    }
    #addGroupInput {
      padding-top: 5px;
    }
    .groupHeader {
      font-weight: bold;
      margin-bottom: 5px;
    }
    #GroupList {
      padding: 5px;
    }
  </style>
  <!--[if lt IE 7]>
  <style type="text/css">
    BODY
    {
      font-size: x-small;
    }
  </style>
  <![endif]-->

  <script type="text/javascript" data-basis-config src="../../src/basis.js"></script>

  <script type="text/javascript" src="../demo.js"></script>
</head>

<body>
  <div id="demo-container"></div>

  <script type="text/javascript" id="demo-javascript">
    var Dataset = basis.require('basis.data').Dataset;
    var Subtract = basis.require('basis.data.dataset').Subtract;
    var entity = basis.require('basis.entity');
    var Node = basis.require('basis.ui').Node;
    var Menu = basis.require('basis.ui.menu').Menu;
    var TextField = basis.require('basis.ui.field').Text;
    var max = basis.require('basis.data.index').max;

    // define types
    var UserGroup = entity.createType('UserGroup', {
      groupId: {
        type: entity.IntId,
        defValue: function() {
          return max(UserGroup.all, 'data.groupId').value + 1 || 1;
        }
      },
      title: String
    });

    var User = entity.createType({
      fields: {
        userId: {
          type: entity.IntId,
          defValue: function() {
            return max(User.all, 'data.userId').value + 1 || 1;
          }
        },
        group: UserGroup,
        title: String
      },
      aliases: {
        groupId: 'group'
      }
    });

    // data
    [
      { title: 'Red' },
      { title: 'Green' },
      { title: 'Blue' },
      { title: 'Black' },
      { title: 'White' },
      { title: 'Yellow' }
    ].map(UserGroup);

    [
      { groupId: 1, title: 'Norman Yuen' },
      { groupId: 2, title: 'Casto' },
      { groupId: 6, title: 'Jose Crutcher' },
      { groupId: 3, title: 'Ralph Peres' },
      { groupId: 5, title: 'Christopher Klaus' },
      { groupId: 5, title: 'Tanya Edison' },
      { groupId: 5, title: 'Paul Seger' },
      { groupId: 4, title: 'Norma Perri' },
      { groupId: 4, title: 'Juan Ewing' },
      { groupId: 4, title: 'Mark Luevano' },
      { groupId: 4, title: 'Curtis Knoll' },
      { groupId: 1, title: 'Terry Patterson' },
      { groupId: 2, title: 'Monique Castellanos' },
      { groupId: 2, title: 'Bryan Waldo' }
    ].map(User.reader).map(User);

    var selectedGroup = new Dataset();
    var nonSelectedGroup = new Subtract({
      minuend: UserGroup.all,
      subtrahend: selectedGroup
    });

    var groupPopup = new Menu({
      dataSource: nonSelectedGroup,
      sorting: basis.getter('data.title'),
      childClass: {
        binding: {
          caption: 'data:title'
        }
      },
      defaultHandler: function(node){
        if (node)
        {
          this.update({
            group: node.target
          });
          this.hide();
        }
      },
      handler: {
        delegateChanged: function(sender, oldDelegate){
          selectedGroup.set([this.data.group]);
        },
        hide: function(){
          this.setDelegate();
        }
      }
    });

    var userList = new Node({
      container: document.getElementById('demo-container'),
      template: '<div id="UserList"/>',

      dataSource: User.all,
      sorting: 'data.title',
      selection: true,
      childClass: {
        template:
          '<div class="user {selected}" event-click="select">' +
            '<div class="groupPanel">' +
              '<span{group} class="noGroup">no group selected</span>' +
              '<button event-click="chooseGroup">..</button>' +
            '</div>' +
            '<span class="user__title">{title}</span>' +
          '</div>',
        binding: {
          group: 'satellite:',
          title: 'data:'
        },
        action: {
          select: function(){
            this.select();
          },
          chooseGroup: function(event){
            groupPopup.setDelegate(this);
            groupPopup.show(event.sender);
          }
        },

        satellite: {
          group: {
            existsIf: 'data.group',
            delegate: 'data.group',
            instance: Node.subclass({
              template: '{title}',
              binding: {
                title: 'data:'
              }
            })
          }
        }
      }
    });

    var groupList = new Node({
      container: document.getElementById('demo-container'),
      template:
      '<div id="GroupList">' +
        '<div class="groupHeader">Group list</div>' +
        '<div{childNodesElement}></div>' +
        '<div id="addGroupInput">' +
          '<div class="groupHeader">Adding group</div>' +
          '<input{groupInput} />' +
          '<button event-click="addGroup">Add group</button>' +
        '</div>' +
      '</div>',
      action: {
        addGroup: function(){
          var inputValue = this.tmpl.groupInput.value;
          if (inputValue) {
            UserGroup({ title: this.tmpl.groupInput.value });
          } else {
            alert('You must enter the value')
          }
        },
      },
      dataSource: UserGroup.all,
      sorting: 'data.groupId',
      childClass: {
        template:
          '<div class="group">' +
            '<button event-click="destroy" tabindex="-1">delete</button>' +
            '<!--{titleEditor}-->' +
          '</div>',
        action: {
          destroy: function(){
            this.target.destroy();
          }
        },
        binding: {
          titleEditor: 'satellite:'
        },

        satellite: {
          titleEditor: TextField.subclass({
            autoDelegate: true,
            maxLength: 32,
            handler: {
              update: function(){
                this.setValue(this.data.title);
              },
              change: function(){
                this.update({
                  title: this.getValue()
                });
              }
            }
          })
        }
      }
    });

  </script>
</body>

</html>
